# Исправление ошибки 1053 при запуске службы

## Проблема

Ошибка 1053 означает: "The service did not respond to the start or control request in a timely fashion" - служба не отвечает на запрос запуска в течение установленного времени (30 секунд по умолчанию).

## Причины

1. **Служба падает при инициализации** - ошибки в коде при запуске
2. **Проблемы с конфигурацией** - не может прочитать config.json
3. **Проблемы с подключением к серверу** - не может зарегистрироваться
4. **Недостаточно времени для инициализации** - служба не успевает запуститься

## Что исправлено

### 1. Улучшена обработка ошибок в Program.cs
- Добавлен try-catch в Main для перехвата критических ошибок
- Ошибки логируются в EventLog с подробным stack trace
- Служба не падает молча

### 2. Улучшено логирование в Config.cs
- Ошибки загрузки конфигурации логируются в EventLog
- Служба продолжает работу с дефолтными значениями при ошибке чтения конфига

### 3. Улучшена диагностика в установщике
- Увеличена задержка после запуска службы с 2 до 5 секунд
- Добавлена проверка EventLog на наличие ошибок
- Показываются последние 5 записей из EventLog при проблемах
- Отображается ExitCode службы для диагностики

### 4. Улучшено логирование запуска
- Показывается код выхода sc.exe
- Показывается вывод и ошибки команды запуска
- Отображается статус службы и ExitCode

## Как проверить

1. **Проверьте EventLog:**
   ```powershell
   Get-EventLog -LogName Application -Source "1CUpdaterAgent" -Newest 10
   ```

2. **Проверьте статус службы:**
   ```powershell
   Get-Service -Name "1CUpdaterAgent"
   sc.exe query "1CUpdaterAgent"
   ```

3. **Проверьте конфигурацию:**
   ```powershell
   Get-Content "C:\ProgramData\1CUpdaterAgent\config.json"
   ```

4. **Проверьте логи установки:**
   - Лог установки находится рядом с установщиком
   - Имя файла: `1CUpdaterAgentInstaller-Install-YYYYMMDD-HHMMSS.log`

## Типичные проблемы и решения

### Проблема: Служба не может прочитать конфигурацию
**Решение:** Проверьте права доступа к `C:\ProgramData\1CUpdaterAgent\config.json`

### Проблема: Служба не может подключиться к серверу
**Решение:** 
- Проверьте URL сервера в конфигурации
- Проверьте доступность сервера: `Test-NetConnection -ComputerName <server> -Port 3001`
- Проверьте файрвол

### Проблема: Служба падает при регистрации
**Решение:** Проверьте EventLog на наличие ошибок регистрации

## Дальнейшая диагностика

Если проблема сохраняется:

1. Запустите агент вручную (не как службу) для проверки:
   ```powershell
   cd "C:\Users\link2\Downloads"
   .\1CUpdaterAgent.exe
   ```
   Это покажет ошибки в консоли

2. Проверьте зависимости:
   ```powershell
   Get-Command 1CUpdaterAgent.exe | Select-Object -ExpandProperty Definition
   ```

3. Проверьте права доступа к файлам и папкам


