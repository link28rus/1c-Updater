# Диагностика проблем с агентом

## Проблема: Агент установлен, но не отображается в веб-интерфейсе

### Шаг 1: Проверка конфигурации

Проверьте файл конфигурации:
```powershell
Get-Content "C:\ProgramData\1CUpdaterAgent\config.json"
```

Должен содержать:
```json
{
  "ServerUrl": "http://192.168.25.200:3001",
  "PcId": 3,
  "AgentId": "61ba6adb-c523-4fbc-a721-3b0673e62dca",
  "PollIntervalSeconds": 30,
  "HeartbeatIntervalSeconds": 60
}
```

**Важно:**
- `PcId` должен соответствовать ID ПК в веб-интерфейсе
- `ServerUrl` должен быть доступен с целевого ПК
- `AgentId` должен быть уникальным GUID

### Шаг 2: Проверка EventLog

Проверьте логи службы:
```powershell
Get-EventLog -LogName Application -Source "1CUpdaterAgent" -Newest 20 | Format-List TimeGenerated, EntryType, Message
```

Ищите:
- ✅ "Агент инициализирован" - агент запустился
- ✅ "Агент успешно зарегистрирован" - регистрация прошла успешно
- ❌ "Ошибка регистрации агента" - проблема с регистрацией
- ❌ "Ошибка отправки heartbeat" - проблема с heartbeat
- ❌ "ОШИБКА: PcId не установлен" - неправильная конфигурация

### Шаг 3: Проверка подключения к серверу

Проверьте доступность сервера с целевого ПК:
```powershell
Test-NetConnection -ComputerName 192.168.25.200 -Port 3001
```

Или через браузер:
```
http://192.168.25.200:3001/api/agent/status
```

### Шаг 4: Проверка статуса службы

```powershell
Get-Service -Name "1CUpdaterAgent"
```

Должен быть в состоянии `Running`.

### Шаг 5: Проверка сетевых запросов

Если возможно, используйте Wireshark или Fiddler для проверки HTTP-запросов от агента к серверу.

## Типичные проблемы

### Проблема 1: PcId = 0 или не установлен
**Решение:** Проверьте конфигурацию и убедитесь, что PcId соответствует ID ПК в веб-интерфейсе.

### Проблема 2: Сервер недоступен
**Решение:** 
- Проверьте доступность сервера с целевого ПК
- Проверьте файрвол
- Убедитесь, что URL сервера правильный

### Проблема 3: Ошибка регистрации
**Решение:**
- Проверьте EventLog на наличие ошибок
- Убедитесь, что эндпоинт `/api/agent/register` доступен
- Проверьте, что PcId существует в базе данных

### Проблема 4: Heartbeat не отправляется
**Решение:**
- Проверьте EventLog
- Убедитесь, что эндпоинт `/api/agent/heartbeat/{agentId}` доступен
- Проверьте интервал HeartbeatIntervalSeconds

## Перезапуск службы

После изменения конфигурации:
```powershell
Restart-Service -Name "1CUpdaterAgent"
```

Или через Services:
1. Откройте `services.msc`
2. Найдите "1C Updater Agent"
3. Правый клик → Перезапустить

## Проверка в реальном времени

Для мониторинга логов в реальном времени:
```powershell
Get-EventLog -LogName Application -Source "1CUpdaterAgent" -Newest 1 -Wait
```

## Контакты

Если проблема не решена, предоставьте:
1. Содержимое `config.json`
2. Последние 20 записей из EventLog
3. Результат `Test-NetConnection` к серверу
4. Статус службы


