# Работа с миграциями базы данных

Проект использует TypeORM миграции для управления схемой базы данных.

## Команды

### Применение миграций

```bash
cd backend
npm run migration:run
```

Эта команда применит все новые миграции к базе данных.

### Откат последней миграции

```bash
cd backend
npm run migration:revert
```

Эта команда откатит последнюю примененную миграцию.

### Генерация новой миграции

После изменения сущностей (entities) можно сгенерировать новую миграцию:

```bash
cd backend
npm run migration:generate -- -n MigrationName
```

Например:
```bash
npm run migration:generate -- -n AddUserEmailColumn
```

## Начальная миграция

Начальная миграция `InitialSchema1704067200000` создает полную схему базы данных:

- Таблица `users` - пользователи системы
- Таблица `groups` - группы ПК
- Таблица `pcs` - компьютеры
- Таблица `distributions` - дистрибутивы 1С
- Таблица `tasks` - задачи обновления
- Таблица `task_pc` - связи задач с ПК
- Таблица `agent_registrations` - регистрации агентов

## Первоначальная настройка

1. Убедитесь, что PostgreSQL запущен и база данных создана:
   ```sql
   CREATE DATABASE "1c_updater";
   ```

2. Настройте `.env` файл в папке `backend/`:
   ```env
   DB_HOST=localhost
   DB_PORT=5432
   DB_USERNAME=postgres
   DB_PASSWORD=your_password
   DB_DATABASE=1c_updater
   ```

3. Примените миграции:
   ```bash
   cd backend
   npm run migration:run
   ```

## Проверка статуса миграций

TypeORM автоматически отслеживает примененные миграции в таблице `migrations`, которая создается автоматически при первом запуске миграций.

## Важные замечания

- **НЕ используйте `synchronize: true`** в production - только миграции
- Всегда тестируйте миграции на тестовой БД перед применением к production
- Делайте резервные копии БД перед применением миграций в production
- Проверяйте, что миграции обратимые (метод `down()` корректен)

